<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head(${formMode == 'create' ? 'New order' : 'Edit order'})}"></head>
<body class="bg-body-tertiary">
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container-fluid">
    <div class="row min-vh-main">
        <div th:replace="~{fragments/sidebar :: sidebar('orders')}"></div>

        <main class="col-12 col-lg-10 px-3 px-md-4 py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h3 mb-0" th:text="${formMode == 'create' ? 'New order' : 'Edit order'}">Order</h1>
                    <div class="text-secondary" th:if="${formMode == 'edit'}" th:text="'ID: ' + ${orderId}"></div>
                </div>
                <div class="d-flex gap-2">
                    <a class="btn btn-outline-secondary" th:href="@{/ui/orders}">Back</a>
                </div>
            </div>

            <div class="alert alert-success" th:if="${successMessage != null}" th:text="${successMessage}"></div>
            <div class="alert alert-danger" th:if="${errorMessage != null}" th:text="${errorMessage}"></div>
            <div class="alert alert-warning" th:if="${dataError != null}" th:text="${dataError}"></div>

            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <form th:object="${orderForm}"
                          method="post"
                          th:action="${formMode == 'create'} ? @{/ui/orders} : @{/ui/orders/{id}(id=${orderId})}">

                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label for="unitId" class="form-label">Unit</label>
                                <select id="unitId" class="form-select"
                                        th:field="*{unitId}"
                                        th:classappend="${#fields.hasErrors('unitId')} ? ' is-invalid'">
                                    <option value="" selected disabled>Select a unit</option>
                                    <option th:each="unit : ${units}"
                                            th:value="${unit.id}"
                                            th:text="${unit.name + (unit.location != null ? ' — ' + unit.location : '')}">
                                    </option>
                                </select>
                                <div class="invalid-feedback" th:errors="*{unitId}">Please check this field.</div>
                            </div>

                            <div class="col-12 col-md-3">
                                <label for="dateCreated" class="form-label">Date created</label>
                                <input id="dateCreated" type="date" class="form-control"
                                       th:field="*{dateCreated}"
                                       th:classappend="${#fields.hasErrors('dateCreated')} ? ' is-invalid'">
                                <div class="invalid-feedback" th:errors="*{dateCreated}">Please check this field.</div>
                            </div>

                            <div class="col-12 col-md-3">
                                <label for="status" class="form-label">Status</label>
                                <select id="status" class="form-select"
                                        th:field="*{status}"
                                        th:classappend="${#fields.hasErrors('status')} ? ' is-invalid'">
                                    <option value="" selected disabled>Select a status</option>
                                    <option th:each="s : ${orderStatuses}" th:value="${s}"
                                            th:text="${s == 'CREATED' ? 'Created' : (s == 'VALIDATED' ? 'Validated' : (s == 'COMPLETED' ? 'Completed' : s))}">
                                    </option>
                                </select>
                                <div class="invalid-feedback" th:errors="*{status}">Please check this field.</div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check2 me-1"></i>
                                Save
                            </button>
                            <a class="btn btn-outline-secondary" th:href="@{/ui/orders}">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm border-0 mt-3" th:if="${formMode == 'create'}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="h5 mb-0">Items (draft)</h2>
                        <span class="text-secondary small">Add items now, then save the order.</span>
                    </div>

                    <form th:object="${draftItemForm}" th:action="@{/ui/orders/draft/items}" method="post" class="row g-2 align-items-end">
                        <!-- keep header values when adding items -->
                        <input type="hidden" name="unitId" th:value="${orderForm.unitId}">
                        <input type="hidden" name="dateCreated" th:value="${orderForm.dateCreated}">
                        <input type="hidden" name="status" th:value="${orderForm.status}">

                        <div class="col-12 col-md-7">
                            <label for="draftResourceId" class="form-label">Resource</label>
                            <select id="draftResourceId" class="form-select"
                                    th:field="*{resourceId}"
                                    th:classappend="${#fields.hasErrors('resourceId')} ? ' is-invalid'">
                                <option value="" selected disabled>Select a resource</option>
                                <option th:each="r : ${resources}"
                                        th:value="${r.id}"
                                        th:text="${r.name + (r.type != null ? ' — ' + r.type : '')}">
                                </option>
                            </select>
                            <div class="invalid-feedback" th:errors="*{resourceId}">Please check this field.</div>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="draftQuantity" class="form-label">Quantity</label>
                            <input id="draftQuantity" type="number" min="1" class="form-control"
                                   th:field="*{quantity}"
                                   th:classappend="${#fields.hasErrors('quantity')} ? ' is-invalid'">
                            <div class="invalid-feedback" th:errors="*{quantity}">Please check this field.</div>
                        </div>
                        <div class="col-12 col-md-2 d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-plus-lg me-1"></i>
                                Add
                            </button>
                        </div>
                    </form>

                    <div class="table-responsive mt-3">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                            <tr>
                                <th>Resource</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:if="${#lists.isEmpty(draftItems)}">
                                <td colspan="3" class="text-center text-secondary py-3">No items added yet.</td>
                            </tr>
                            <tr th:each="row : ${draftItems}">
                                <td>
                                    <div class="fw-semibold" th:text="${row.resourceName}"></div>
                                    <div class="small text-secondary" th:if="${row.resourceType != null}" th:text="${row.resourceType}"></div>
                                </td>
                                <td class="text-end fw-semibold" th:text="${row.quantity}"></td>
                                <td class="text-end">
                                    <form class="d-inline" method="post"
                                          th:action="@{/ui/orders/draft/items/{index}/remove(index=${row.index})}">
                                        <!-- keep header values when removing items -->
                                        <input type="hidden" name="unitId" th:value="${orderForm.unitId}">
                                        <input type="hidden" name="dateCreated" th:value="${orderForm.dateCreated}">
                                        <input type="hidden" name="status" th:value="${orderForm.status}">
                                        <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                                    </form>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mt-3" th:if="${formMode == 'edit'}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="h5 mb-0">Items</h2>
                    </div>

                    <form th:object="${inlineItemForm}" th:action="@{/ui/orders/{id}/items/inline-add(id=${orderId})}" method="post" class="row g-2 align-items-end">
                        <div class="col-12 col-md-7">
                            <label for="inlineResourceId" class="form-label">Resource</label>
                            <select id="inlineResourceId" class="form-select"
                                    th:field="*{resourceId}"
                                    th:classappend="${#fields.hasErrors('resourceId')} ? ' is-invalid'">
                                <option value="" selected disabled>Select a resource</option>
                                <option th:each="r : ${resources}"
                                        th:value="${r.id}"
                                        th:text="${r.name + (r.type != null ? ' — ' + r.type : '')}">
                                </option>
                            </select>
                            <div class="invalid-feedback" th:errors="*{resourceId}">Please check this field.</div>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="inlineQuantity" class="form-label">Quantity</label>
                            <input id="inlineQuantity" type="number" min="1" class="form-control"
                                   th:field="*{quantity}"
                                   th:classappend="${#fields.hasErrors('quantity')} ? ' is-invalid'">
                            <div class="invalid-feedback" th:errors="*{quantity}">Please check this field.</div>
                        </div>
                        <div class="col-12 col-md-2 d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-plus-lg me-1"></i>
                                Add
                            </button>
                        </div>
                    </form>

                    <div class="table-responsive mt-3">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                            <tr>
                                <th>Resource</th>
                                <th class="text-end" style="width: 160px;">Quantity</th>
                                <th class="text-end">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:if="${#lists.isEmpty(orderItems)}">
                                <td colspan="3" class="text-center text-secondary py-3">No items in this order.</td>
                            </tr>
                            <tr th:each="item : ${orderItems}">
                                <td>
                                    <div class="fw-semibold" th:text="${item.resource != null ? item.resource.name : '—'}"></div>
                                    <div class="small text-secondary" th:if="${item.resource != null}" th:text="${item.resource.type}"></div>
                                </td>
                                <td class="text-end">
                                    <form class="d-flex justify-content-end gap-2" method="post"
                                          th:action="@{/ui/orders/{orderId}/items/{itemId}/inline-update(orderId=${orderId},itemId=${item.id})}">
                                        <input class="form-control form-control-sm text-end" style="max-width: 110px;" type="number" min="1" name="quantity" th:value="${item.quantity}">
                                        <button class="btn btn-sm btn-outline-primary" type="submit">Update</button>
                                    </form>
                                </td>
                                <td class="text-end">
                                    <form class="d-inline" method="post"
                                          th:action="@{/ui/orders/{orderId}/items/{itemId}/inline-delete(orderId=${orderId},itemId=${item.id})}"
                                          onsubmit="return confirm('Remove this item from the order?');">
                                        <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                                    </form>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<th:block th:replace="~{fragments/scripts :: scripts}"></th:block>
</body>
</html>
