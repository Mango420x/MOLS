<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Dashboard')}"></head>
<body class="bg-body-tertiary">
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container-fluid">
    <div class="row min-vh-main">
        <div th:replace="~{fragments/sidebar :: sidebar('dashboard')}"></div>

        <main class="col-12 col-lg-10 px-3 px-md-4 py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h3 mb-0">Dashboard</h1>
                    <div class="text-secondary">Operational overview and actionable alerts.</div>
                </div>
            </div>

            <div th:replace="~{fragments/alerts :: alerts}"></div>

            <!-- KPI Cards Row (6) -->
            <div class="row g-3">
                <div class="col-12 col-sm-6 col-md-2">
                    <div class="card border-primary border-2 h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="text-secondary small text-uppercase">Total Orders</div>
                                <i class="bi bi-receipt text-primary"></i>
                            </div>
                            <div class="h3 mb-1 fw-semibold"
                                 th:classappend="${hasOrders ? ' text-primary' : ' text-secondary'}"
                                 th:text="${hasOrders ? totalOrders : '—'}">—</div>
                            <div class="small">
                                <span th:if="${pendingOrders > 0}">
                                    <span class="badge text-bg-warning" th:text="${pendingOrders} + ' pending'">0 pending</span>
                                </span>
                                <span th:unless="${pendingOrders > 0}" class="text-secondary">No pending orders</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-sm-6 col-md-2">
                    <div class="card border-success border-2 h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="text-secondary small text-uppercase">Stock Value</div>
                                <i class="bi bi-boxes text-success"></i>
                            </div>
                            <div class="h3 mb-1 fw-semibold"
                                 th:classappend="${hasStock ? ' text-success' : ' text-secondary'}"
                                 th:text="${hasStock ? totalStockQuantity : '—'}">—</div>
                            <div class="small text-secondary" th:text="${stockWarehouseCount > 0 ? 'Across ' + stockWarehouseCount + ' warehouses' : 'No stock yet'}">Across 0 warehouses</div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-sm-6 col-md-2">
                    <div class="card border-info border-2 h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="text-secondary small text-uppercase">Active Shipments</div>
                                <i class="bi bi-truck-flatbed text-info"></i>
                            </div>
                            <div class="h3 mb-1 fw-semibold text-info" th:text="${activeShipments}">0</div>
                            <div class="small text-secondary">In transit</div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-sm-6 col-md-2">
                    <div class="card border-danger border-2 h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="text-secondary small text-uppercase">Low Stock Alerts</div>
                                <i class="bi bi-exclamation-triangle text-danger"></i>
                            </div>
                            <div class="h3 mb-1 fw-semibold"
                                 th:classappend="${lowStockCount > 0 ? ' text-danger' : ' text-secondary'}"
                                 th:text="${lowStockCount}">0</div>
                            <div class="small">
                                <span th:if="${lowStockCount > 0}" class="text-danger fw-semibold">
                                    <i class="bi bi-lightning-charge-fill me-1"></i>Action needed
                                </span>
                                <span th:unless="${lowStockCount > 0}" class="text-secondary">
                                    <i class="bi bi-check2-circle me-1"></i>All good
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-sm-6 col-md-2">
                    <div class="card border-warning border-2 h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="text-secondary small text-uppercase">Recent Activity</div>
                                <i class="bi bi-clock-history text-warning"></i>
                            </div>
                            <div class="h3 mb-1 fw-semibold"
                                 th:classappend="${recentMovementsCount > 0 ? ' text-warning' : ' text-secondary'}"
                                 th:text="${recentMovementsCount}">0</div>
                            <div class="small text-secondary">Last 24 hours</div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-sm-6 col-md-2">
                    <div class="card border-success border-2 h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="text-secondary small text-uppercase">Fulfillment Rate</div>
                                <i class="bi bi-check2-square text-success"></i>
                            </div>
                            <div class="h3 mb-1 fw-semibold"
                                 th:classappend="${hasOrders ? ' text-success' : ' text-secondary'}"
                                 th:text="${hasOrders ? #numbers.formatDecimal(fulfillmentRatePercent, 1, 0) + '%' : '—'}">—</div>
                            <div class="small">
                                <span th:if="${hasOrders and fulfillmentTargetMet}" class="text-success fw-semibold">
                                    <i class="bi bi-check2-circle me-1"></i>Target met
                                </span>
                                <span th:unless="${hasOrders and fulfillmentTargetMet}" class="text-secondary"
                                      th:text="${'Target: ' + fulfillmentTargetPercent + '%'}">Target: 90%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section (3) -->
            <div class="row g-3 mt-1">
                <div class="col-12 col-md-6 col-xl-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h2 class="h6 mb-0">Stock Distribution by Warehouse</h2>
                                <a class="small text-decoration-none" th:href="@{/ui/stocks}">Manage stock</a>
                            </div>
                            <div th:if="${!hasStock}" class="alert alert-secondary mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                No stock data yet.
                            </div>
                            <div th:if="${hasStock}" style="height: 280px;">
                                <canvas id="chartStockByWarehouse"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6 col-xl-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h2 class="h6 mb-0">Movements by Type (30 days)</h2>
                                <a class="small text-decoration-none" th:href="@{/ui/movements}">View audit log</a>
                            </div>
                            <div th:if="${!hasMovementChartData}" class="alert alert-secondary mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Not enough movement history yet.
                            </div>
                            <div th:if="${hasMovementChartData}" style="height: 280px;">
                                <canvas id="chartMovementsByType"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6 col-xl-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h2 class="h6 mb-0">Orders by Status</h2>
                                <a class="small text-decoration-none" th:href="@{/ui/orders}">Manage orders</a>
                            </div>
                            <div th:if="${!hasOrdersChartData}" class="alert alert-secondary mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                No orders yet.
                            </div>
                            <div th:if="${hasOrdersChartData}" style="height: 280px;">
                                <canvas id="chartOrdersByStatus"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card mt-3 border-0 shadow-sm">
                <div class="card-body pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="h5 mb-0">Recent Activity</h2>
                        <a class="small text-decoration-none" th:href="@{/ui/movements}">View all</a>
                    </div>
                    <div class="text-secondary">Last 15 stock movements.</div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Resource</th>
                            <th class="text-end">Quantity</th>
                            <th>Warehouse</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${#lists.isEmpty(recentMovements)}">
                            <td colspan="5" class="text-center text-secondary py-4">
                                No recent activity to display.
                            </td>
                        </tr>
                        <tr th:each="m : ${recentMovements}">
                            <td class="text-nowrap" th:text="${m.dateTime != null ? #temporals.format(m.dateTime, 'HH:mm') : '-'}">00:00</td>
                            <td>
                                <span class="badge"
                                      th:classappend="${m.type == 'ENTRY'} ? ' text-bg-success' : (${m.type == 'EXIT'} ? ' text-bg-danger' : ' text-bg-warning')"
                                      th:text="${m.type != null ? m.type : 'UNKNOWN'}">ENTRY</span>
                            </td>
                            <td th:text="${m.stock != null && m.stock.resource != null ? m.stock.resource.name : '-'}">-</td>
                            <td class="text-end" th:text="${m.quantity}">0</td>
                            <td th:text="${m.stock != null && m.stock.warehouse != null ? m.stock.warehouse.name : '-'}">-</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Alerts Section -->
            <div class="row g-3 mt-1">
                <div class="col-12 col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h2 class="h5 mb-0">Low Stock Alerts</h2>
                                <a class="small text-decoration-none" th:href="@{/ui/stocks}">Stock</a>
                            </div>

                            <div th:if="${!hasLowStock}" class="alert alert-success mb-0">
                                <i class="bi bi-check2-circle me-1"></i>
                                All stock levels healthy.
                            </div>

                            <div th:if="${hasLowStock}" class="list-group list-group-flush">
                                <div class="list-group-item px-0" th:each="s : ${lowStockItems}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-semibold" th:text="${s.resource != null ? s.resource.name : '—'}">Resource</div>
                                            <div class="small text-secondary">
                                                <span th:text="${s.warehouse != null ? s.warehouse.name : '—'}">Warehouse</span>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge"
                                                  th:classappend="${s.quantity < criticalStockThreshold} ? ' text-bg-danger' : ' text-bg-warning'"
                                                  th:text="${s.quantity}">0</span>
                                            <div class="small">
                                                <a class="text-decoration-none" th:href="@{/ui/stocks/{id}/adjust(id=${s.id})}">
                                                    Adjust
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-2" th:if="${lowStockTotalCount > lowStockLimit}">
                                    <a th:href="@{/ui/stocks}" class="text-decoration-none">
                                        View all <span th:text="${lowStockTotalCount}">0</span> low stock items
                                    </a>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h2 class="h5 mb-0">Pending Orders</h2>
                                <a class="small text-decoration-none" th:href="@{/ui/orders}">Orders</a>
                            </div>
                            <div class="text-secondary mb-2" th:text="${'Pending for more than ' + staleOrdersDays + ' days'}">Pending for more than 3 days</div>

                            <div th:if="${!hasStaleOrders}" class="alert alert-success mb-0">
                                <i class="bi bi-check2-circle me-1"></i>
                                No stale orders.
                            </div>

                            <div th:if="${hasStaleOrders}" class="list-group list-group-flush">
                                <div class="list-group-item px-0" th:each="o : ${staleOrders}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <a class="fw-semibold text-decoration-none"
                                               th:href="@{/ui/orders/{id}(id=${o.orderId})}"
                                               th:text="${'Order #' + o.orderId}">Order #1</a>
                                            <div class="small text-secondary" th:text="${o.unitName}">Unit</div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge"
                                                  th:classappend="${o.daysPending > 7} ? ' text-bg-danger' : (${o.daysPending >= 3} ? ' text-bg-warning' : ' text-bg-secondary')"
                                                  th:text="${o.daysPending + ' days'}">3 days</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<th:block th:replace="~{fragments/scripts :: scripts}"></th:block>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script th:inline="javascript">
    (() => {
        const chartData = /*[[${chartData}]]*/ {};

        const cssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

        const getThemeTokens = () => {
            const bodyColor = cssVar('--bs-body-color') || '#212529';
            const borderColor = cssVar('--bs-border-color') || 'rgba(0,0,0,.125)';
            return {
                bodyColor,
                borderColor,
                primaryRgb: cssVar('--bs-primary-rgb') || '13,110,253',
                successRgb: cssVar('--bs-success-rgb') || '25,135,84',
                dangerRgb: cssVar('--bs-danger-rgb') || '220,53,69',
                warningRgb: cssVar('--bs-warning-rgb') || '255,193,7'
            };
        };

        const applyChartDefaults = () => {
            const t = getThemeTokens();
            Chart.defaults.color = t.bodyColor;
            Chart.defaults.borderColor = t.borderColor;
            Chart.defaults.plugins.legend.labels.usePointStyle = true;
            Chart.defaults.plugins.legend.labels.boxWidth = 10;
            return t;
        };

        const filterZeros = (labels, values) => {
            const filtered = { labels: [], values: [] };
            for (let i = 0; i < labels.length; i++) {
                const v = Number(values[i] ?? 0);
                if (v > 0) {
                    filtered.labels.push(labels[i]);
                    filtered.values.push(v);
                }
            }
            return filtered;
        };

        const doughnutCenterText = {
            id: 'doughnutCenterText',
            afterDraw(chart, args, options) {
                if (!options || typeof options.text !== 'string') return;
                const { ctx, chartArea: { left, right, top, bottom } } = chart;
                const x = (left + right) / 2;
                const y = (top + bottom) / 2;
                ctx.save();
                ctx.fillStyle = cssVar('--bs-body-color') || '#212529';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '600 18px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';
                ctx.fillText(options.text, x, y);
                ctx.restore();
            }
        };

        const charts = {
            stockByWarehouse: null,
            movementsByType: null,
            ordersByStatus: null,
            movementsTotal: 0
        };

        const updateChartsTheme = () => {
            const t = applyChartDefaults();

            if (charts.stockByWarehouse) {
                const labels = charts.stockByWarehouse.data.labels || [];
                const denom = Math.max(1, labels.length - 1);
                charts.stockByWarehouse.data.datasets[0].backgroundColor = labels.map((_, i) => {
                    const alpha = 0.35 + (0.55 * (i / denom));
                    return `rgba(${t.primaryRgb}, ${alpha.toFixed(3)})`;
                });
                charts.stockByWarehouse.options.scales.x.grid.color = t.borderColor;
                charts.stockByWarehouse.options.scales.x.ticks.color = t.bodyColor;
                charts.stockByWarehouse.options.scales.y.ticks.color = t.bodyColor;
                charts.stockByWarehouse.update();
            }

            if (charts.movementsByType) {
                const labels = charts.movementsByType.data.labels || [];
                const colorMap = {
                    'ENTRY': `rgba(${t.successRgb}, 0.85)`,
                    'EXIT': `rgba(${t.dangerRgb}, 0.85)`,
                    'ADJUSTMENT': `rgba(${t.warningRgb}, 0.85)`
                };
                charts.movementsByType.data.datasets[0].backgroundColor = labels.map(l => colorMap[l] || `rgba(${t.warningRgb}, 0.85)`);
                charts.movementsByType.options.plugins.doughnutCenterText.text = String(charts.movementsTotal);
                charts.movementsByType.update();
            }

            if (charts.ordersByStatus) {
                const labels = charts.ordersByStatus.data.labels || [];
                const colorMap = {
                    'PENDING': `rgba(${t.warningRgb}, 0.85)`,
                    'COMPLETED': `rgba(${t.successRgb}, 0.85)`,
                    'CANCELLED': `rgba(${t.dangerRgb}, 0.85)`
                };
                charts.ordersByStatus.data.datasets[0].backgroundColor = labels.map(l => colorMap[l] || `rgba(${t.warningRgb}, 0.85)`);
                charts.ordersByStatus.update();
            }
        };

        // Chart 1: Stock Distribution by Warehouse (Horizontal Bar)
        if (document.getElementById('chartStockByWarehouse')) {
            const labels = chartData.stockByWarehouse?.labels || [];
            const values = chartData.stockByWarehouse?.values || [];
            const t = applyChartDefaults();
            const denom = Math.max(1, labels.length - 1);
            const bg = labels.map((_, i) => {
                const alpha = 0.35 + (0.55 * (i / denom));
                return `rgba(${t.primaryRgb}, ${alpha.toFixed(3)})`;
            });

            charts.stockByWarehouse = new Chart(document.getElementById('chartStockByWarehouse'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total quantity',
                        data: values,
                        backgroundColor: bg,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        x: {
                            grid: { color: t.borderColor },
                            ticks: { color: t.bodyColor }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: t.bodyColor }
                        }
                    }
                }
            });
        }

        // Chart 2: Movements by Type (Doughnut)
        if (document.getElementById('chartMovementsByType')) {
            const labels = chartData.movementsByType?.labels || [];
            const values = chartData.movementsByType?.values || [];
            charts.movementsTotal = Number(chartData.movementsByType?.total || 0);
            const filtered = filterZeros(labels, values);

            const t = getThemeTokens();
            const colorMap = {
                'ENTRY': `rgba(${t.successRgb}, 0.85)`,
                'EXIT': `rgba(${t.dangerRgb}, 0.85)`,
                'ADJUSTMENT': `rgba(${t.warningRgb}, 0.85)`
            };
            const bg = filtered.labels.map(l => colorMap[l] || `rgba(${t.warningRgb}, 0.85)`);

            charts.movementsByType = new Chart(document.getElementById('chartMovementsByType'), {
                type: 'doughnut',
                data: {
                    labels: filtered.labels,
                    datasets: [{
                        data: filtered.values,
                        backgroundColor: bg,
                        borderWidth: 0
                    }]
                },
                plugins: [doughnutCenterText],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom' },
                        doughnutCenterText: { text: String(charts.movementsTotal) }
                    }
                }
            });
        }

        // Chart 3: Orders by Status (Pie)
        if (document.getElementById('chartOrdersByStatus')) {
            const labels = chartData.ordersByStatus?.labels || [];
            const values = chartData.ordersByStatus?.values || [];
            const filtered = filterZeros(labels, values);

            const t = getThemeTokens();
            const colorMap = {
                'PENDING': `rgba(${t.warningRgb}, 0.85)`,
                'COMPLETED': `rgba(${t.successRgb}, 0.85)`,
                'CANCELLED': `rgba(${t.dangerRgb}, 0.85)`
            };
            const bg = filtered.labels.map(l => colorMap[l] || `rgba(${t.warningRgb}, 0.85)`);

            charts.ordersByStatus = new Chart(document.getElementById('chartOrdersByStatus'), {
                type: 'pie',
                data: {
                    labels: filtered.labels,
                    datasets: [{
                        data: filtered.values,
                        backgroundColor: bg,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Update charts when switching theme (no reload needed)
        document.addEventListener('mols:theme-changed', () => {
            window.requestAnimationFrame(updateChartsTheme);
        });
    })();
</script>
</body>
</html>
